## Caisse MyConfort ‚Äî √âtat des lieux et configuration (sept. 2025)

### Ce qui a √©t√© fait
- Netlify Functions: mise en place de deux fonctions
  - `caisse-facture` (CommonJS) ‚Äî endpoint simple de test
  - `n8n` ‚Äî proxy vers n8n avec retrait du pr√©fixe `/api/n8n`
- Routage Netlify
  - `public/_redirects`: forc√© avec `200!` pour `/api/n8n/*` et `/api/*`
  - `netlify.toml`: variables d‚Äôenv et headers no‚Äëcache, fonctions `netlify/functions`
- Environnement app (Vite)
  - `VITE_N8N_URL=/api/n8n`
  - `VITE_EXTERNAL_INVOICES_URL=/api/n8n/caisse/factures`
  - `VITE_EXTERNAL_INVOICES_RUN_URL=/api/n8n/caisse/facture`
- UI/Service factures externes
  - Suppression des gardes qui masquaient les factures en prod
  - Normalisation TTC plus tol√©rante (`amount`, `total`)
  - Rafra√Æchissement depuis `localStorage` sur l‚Äô√©v√©nement `external-invoices-updated`
- Composants
  - `InvoicesTabCompact`: bouton ‚ÄúSynchroniser tout‚Äù + ‚ÄúDiagnostic‚Äù, vue externes

### Ce qui coince encore (Supabase/n8n)
- GET n8n: le proxy r√©pond, mais 404 si le webhook `GET caisse/factures` n‚Äôest pas actif.
- n8n ‚Äî Respond: il faut renvoyer un tableau complet. Utiliser une expression c√¥t√© ‚ÄúRespond (GET)‚Äù: `$items().map(item => item.json)`

### Proc√©dure n8n (liste)
1. Webhook (GET): Path `caisse/factures`, workflow Active
2. HTTP Supabase List: URL avec `limit`, headers, format JSON
3. Respond (GET): Respond with JSON, body: `$items().map(item => item.json)`

### Bypass urgence ‚Äî Import direct sans base de donn√©es
- Ajout d‚Äôun m√©canisme d‚Äôimport direct via hash URL
  - Fichier: `src/services/directImport.ts`
  - Au chargement de l‚Äôapp (`src/main.tsx`), `processImportFromHash()` d√©tecte `#import=<base64(json)>`,
    normalise en facture, l‚Äôins√®re (store local), puis cr√©e une vente (IndexedDB) pour le CA et les ventes.

Exemple d‚ÄôURL d‚Äôimport:
```
https://votre-domaine.netlify.app/#import=<BASE64_DU_JSON>
```
JSON minimum attendu (format avec prix TTC et remise):
```json
{
  "numero_facture": "F-TEST-001",
  "date_facture": "2025-09-23",
  "nom_client": "Client Demo",
  "montant_ttc": 120,
  "payment_method": "card",
  "vendeuse": "Alice",
  "produits": [
    {
      "nom": "Produit X",
      "quantite": 1,
      "prix_ttc": 120,
      "remise": 0
    }
  ]
}
```

Le JSON est encod√© en base64 (UTF‚Äë8). √Ä l‚Äôouverture de l‚ÄôURL, la facture est stock√©e et une vente est cr√©√©e imm√©diatement (CA vendeuse mis √† jour, visible dans l‚Äôonglet Ventes).

### Format Produit Attendu (quantit√©, prix TTC, remise)

Pour les produits dans les factures, le syst√®me attend ce format :

```json
{
  "produits": [
    {
      "nom": "Matelas 140x190",
      "quantite": 1,
      "prix_ttc": 1440,
      "remise": 0.2
    }
  ]
}
```

- `quantite` : nombre d'unit√©s
- `prix_ttc` : prix TTC par unit√© (apr√®s remise)
- `remise` : taux de remise appliqu√©e (ex: 0.2 = 20%)

### R√®gle d'Idempotence

- **Cl√© unique** : `numero_facture`
- **Comportement** : Si une facture avec le m√™me num√©ro existe d√©j√†, elle est mise √† jour (upsert) au lieu d'√™tre dupliqu√©e
- **Pr√©vention des doublons** : Garantit qu'une m√™me facture n'est comptabilis√©e qu'une seule fois dans le CA

## üîß Guide Workflow n8n - Correction JSON Complet

### Probl√®me
Le n≈ìud "Caisse Push (direct)" envoie un objet vide au lieu du JSON complet.

### Solution
**Pipeline correct :** Webhook ‚Üí Normalize ‚Üí Caisse Push (direct) ‚Üí Respond

### Configuration D√©taill√©e

#### 1Ô∏è‚É£ N≈ìud "Normalize" (Code node)
**Function :**
```javascript
// Transformation des donn√©es pour format Caisse
const input = $json;

// Debug: voir la structure exacte des donn√©es
console.log('üîç INPUT STRUCTURE:', JSON.stringify(input, null, 2));

// Extraction robuste des champs avec tous les noms possibles
const numero_facture = String(
  input.numero_facture ||
  input.numero ||
  input.facture_numero ||
  input.invoiceNumber ||
  input.number ||
  input.id ||
  `F-${Date.now()}`
).trim();

const montant_ttc = Number(
  input.montant_ttc ||
  input.total_ttc ||
  input.montantTTC ||
  input.totalTTC ||
  input.amount ||
  input.total ||
  0
);

const vendeuse = String(
  input.vendeuse ||
  input.vendorName ||
  input.conseiller ||
  input.vendeur ||
  input.seller ||
  input.salesperson ||
  'Externe'
).trim();

const vendorId = String(
  input.vendorId ||
  input.vendeuse_id ||
  input.conseiller_id ||
  vendeuse.toLowerCase().replace(/\s+/g, '')
).trim() || 'external';

// Produits - essayer tous les formats possibles
let produits = [];
if (Array.isArray(input.produits)) {
  produits = input.produits;
} else if (Array.isArray(input.products)) {
  produits = input.products;
} else if (Array.isArray(input.items)) {
  produits = input.items;
} else if (Array.isArray(input.lignes)) {
  produits = input.lignes;
} else if (input.produit) {
  // Format objet unique
  produits = [input.produit];
}

// Transformation des produits
const produitsTransformes = produits.map((p, idx) => ({
  nom: String(p.nom || p.name || p.productName || p.description || `Produit ${idx + 1}`),
  quantite: Number(p.quantite || p.quantity || p.qty || p.quantite_produit || 1),
  prix_ttc: Number(p.prix_ttc || p.unitPriceTTC || p.priceTTC || p.prix_unitaire_ttc || 0),
  remise: Number(p.remise || p.discount || p.taux_remise || 0)
}));

// Validation et transformation finale
const output = {
  numero_facture: numero_facture || `F-${Date.now()}`,
  date_facture: String(input.date_facture || input.invoiceDate || input.date || new Date().toISOString().slice(0,10)),
  nom_client: String(input.nom_client || input.client?.name || input.customerName || 'Client'),
  montant_ttc: montant_ttc > 0 ? montant_ttc : produitsTransformes.reduce((sum, p) => sum + (p.prix_ttc * p.quantite), 0),
  payment_method: String(input.payment_method || input.payment?.method || input.mode_paiement || 'card'),
  vendeuse: vendeuse,
  vendorId: vendorId,
  produits: produitsTransformes
};

// Debug: voir le r√©sultat
console.log('‚úÖ OUTPUT TRANSFORMED:', JSON.stringify(output, null, 2));

return [ { json: output } ];
```

#### 2Ô∏è‚É£ N≈ìud "Caisse Push (direct)" (HTTP Request)
**Method :** POST
**URL :** `https://caissemyconfort2025.netlify.app/api/caisse/facture`
**Headers :**
```
Content-Type: application/json
X-Secret: MySuperSecretKey2025
```
**Body Content Type :** JSON
**Body Parameters :**
```
JSON: {{ $json }}
```

‚ö†Ô∏è **PROBL√àME IDENTIFI√â :** Le n≈ìud HTTP envoie `{"data": "JSON_STRING"}` au lieu du JSON direct !

**SOLUTION :**
1. Dans l'onglet "Body Parameters" du n≈ìud HTTP
2. **Cliquez sur "Add Expression"** (pas "Add Field")
3. **Tapez :** `$json`
4. **Assurez-vous que c'est en mode Expression** (petite ic√¥ne fx)
5. **Le body doit montrer le JSON complet** (pas encapsul√© dans "data")

#### 3Ô∏è‚É£ Contr√¥les √† Effectuer

1. **Debug - Voir la Structure Entrante :**
   - Ajoutez un n≈ìud "Code" temporaire avant Normalize
   - Code : `return [{ json: $json }];` (sans transformation)
   - Ex√©cutez et voyez la structure exacte dans les logs console

2. **Test Normalize :**
   - Ex√©cutez seulement jusqu'√† Normalize
   - V√©rifiez les logs console pour voir "üîç INPUT STRUCTURE" et "‚úÖ OUTPUT TRANSFORMED"
   - OUTPUT doit contenir : numero_facture non vide, montant_ttc > 0, vendeuse "Sylvie", vendorId "sylvie", produits ‚â• 1

3. **Test HTTP Body :**
   - Dans l'onglet Request du n≈ìud HTTP
   - Body doit montrer le JSON complet (pas de champ "data")
   - R√©ponse attendue : `{"ok":true,"enqueued":1}`

4. **Debug Complet :**
   - Si probl√®me persiste, ajoutez temporairement :
   ```javascript
   // Debug temporaire
   console.log('üìã DEBUG - All input keys:', Object.keys($json));
   console.log('üìã DEBUG - All input values:', JSON.stringify($json, null, 2));
   ```

5. **Test du Body HTTP :**
   - Dans l'onglet "Request" du n≈ìud HTTP
   - Le body doit montrer le JSON complet SANS encapsulation "data"
   - Si vous voyez `{"data": "JSON_STRING"}`, c'est le probl√®me !

#### 4Ô∏è‚É£ Plan de Secours (si Body encore vide)

**Ajoutez un n≈ìud "Set" entre Normalize et HTTP :**
- **Mode :** Keep Only Set = ON
- **Fields :**
  ```
  numero_facture: {{ $json.numero_facture }}
  date_facture: {{ $json.date_facture }}
  nom_client: {{ $json.nom_client }}
  montant_ttc: {{ $json.montant_ttc }}
  payment_method: {{ $json.payment_method }}
  vendeuse: {{ $json.vendeuse }}
  vendorId: {{ $json.vendorId }}
  produits: {{ $json.produits }}
  ```

### Format JSON Final Attendu
```json
{
  "numero_facture": "F-SYL-001",
  "date_facture": "2025-09-23",
  "nom_client": "Client Test",
  "montant_ttc": 1440,
  "payment_method": "card",
  "vendeuse": "Sylvie",
  "vendorId": "sylvie",
  "produits": [
    {
      "nom": "Matelas 140x190",
      "quantite": 1,
      "prix_ttc": 1440,
      "remise": 0.2
    }
  ]
}
```

### Exemple de Structure JSON Entrante (avant Normalize)
```json
{
  "id": "invoice-123",
  "numero_facture": "F-SYL-001",
  "date_facture": "2025-09-23",
  "client": {
    "nom": "Client Test",
    "email": "client@test.com"
  },
  "montant_ttc": 1440,
  "payment_method": "card",
  "vendeuse": "Sylvie",
  "produits": [
    {
      "nom": "Matelas 140x190",
      "quantite": 1,
      "prix_ttc": 1440,
      "remise": 0.2
    }
  ]
}
```

### Test Final
- Rechargez l'app Caisse (cache vide)
- Cr√©ez une facture sur l'iPad
- Attendez 5-10 secondes
- V√©rifiez : "Factures", "Ventes" et "CA instant" mis √† jour

### √âtapes suivantes conseill√©es
- Finaliser la route n8n (GET) et retester `/api/n8n/caisse/factures?limit=10`
- Option serveur (webhook ‚Üí polling) si besoin d'un flux push c√¥t√© "Facture"

# üè™ Caisse MyConfort - Application de Gestion

## üéØ PROJET PRINCIPAL : `mon-projet-vite/`

**‚ö†Ô∏è IMPORTANT** : Utiliser UNIQUEMENT le projet Vite dans le dossier `mon-projet-vite/`

## ‚ö° VS Code Turbo ‚Äì MyConfort

Configuration optimis√©e pour une productivit√© maximale avec React + Vite + TypeScript + Tailwind.

**üìã Setup complet :** [`docs/dev/VSCode-Setup.md`](./docs/dev/VSCode-Setup.md)

**TL;DR :**
- üöÄ Startup √©pur√©, format automatique on save
- ü§ñ Copilot activ√© pour le code uniquement  
- üéØ Port 5173 exclusif, optimisations Vite
- üé§ Flow dict√©e sans interf√©rences VS Code

### üöÄ D√©marrage

```bash
cd mon-projet-vite
npm run dev
```

**URL** : http://localhost:5173 (ou 5174, 5175 selon disponibilit√©)

### ‚ú® Fonctionnalit√©s

- ‚úÖ **Interface factures √©l√©gante** avec tableau produits
- ‚úÖ **D√©duction automatique du stock** lors de l'arriv√©e de factures N8N
- ‚úÖ **Synchronisation N8N** en temps r√©el
- ‚úÖ **Gestion du stock physique** avec alertes visuelles
- ‚úÖ **Tra√ßabilit√© compl√®te** des mouvements de stock
- ‚úÖ **Interface intuitive** avec onglets d√©di√©s

### üì± Navigation

- **Onglet Factures** : Visualisation des factures N8N avec interface √©l√©gante
- **Onglet Stock > Stock physique** : Gestion du stock avec d√©ductions automatiques
- **Autres onglets** : Ventes, Produits, etc.

### üîÑ Workflow Automatique

1. **Facture N8N re√ßue** ‚Üí Synchronisation automatique
2. **Produits d√©tect√©s** ‚Üí D√©duction automatique du stock
3. **Alertes g√©n√©r√©es** ‚Üí Notifications visuelles si stock faible
4. **Tra√ßabilit√©** ‚Üí Historique complet des mouvements

### üìö Documentation

- `DEDUCTION-STOCK-AUTOMATIQUE-v3.0.0.md` : Documentation de la d√©duction automatique
- `AMELIORATION-INTERFACE-FACTURES-v2.1.0.md` : Documentation de l'interface factures

### üîó Synchronisation des factures (n8n)

#### Endpoints principaux

- POST `/webhook/caisse/facture` ‚Äî re√ßoit une facture individuelle (peut inclure `html_content` pour un email HTML pr√©‚Äërendu)
- GET `/sync/invoices` ‚Äî r√©cup√®re la liste des factures depuis n8n
- PATCH `/webhook/invoices/{id}/items/{itemId}/status` ‚Äî met √† jour le statut d‚Äôun produit

#### Payload JSON attendu (exemple)

```json
{
  "numero_facture": "TEST-012",
  "date_facture": "2025-09-19",
  "nom_client": "Client Demo",
  "email_client": "demo@example.com",
  "telephone_client": "...",
  "montant_ht": 1200,
  "montant_ttc": 1440,
  "total_tva": 240,
  "payment_method": "CB",
  "status": "pending",
  "produits": [
    { "nom": "Produit A", "quantite": 2, "prix_ht": 600, "prix_ttc": 720, "tva": 120 }
  ],
  "html_content": "<html>...</html>"
}
```

#### Services & scripts c√¥t√© app

- `mon-projet-vite/src/services/externalInvoiceService.ts` (r√©ception/normalisation/cache)
- `mon-projet-vite/src/services/syncService.ts` (GET/PATCH n8n)
- Scripts de diagnostic: `diagnostic-factures.js`, `raz-complet-factures.js`, `test-factures.sh`

#### Variables d‚Äôenvironnement utiles

- `VITE_EXTERNAL_INVOICES_URL`, `VITE_INVOICE_AUTH_TOKEN`, `VITE_EXTERNAL_RUN_SECRET`
- `VITE_N8N_WEBHOOK_URL`, `VITE_N8N_URL`

#### Notes d‚Äôint√©gration

- L‚Äôapp supporte l‚Äôenvoi d‚Äôun HTML pr√©‚Äërendu via `html_content` pour l‚Äôemail client (contournement des limites de template c√¥t√© Gmail/n8n).
- La synchronisation peut √™tre d√©clench√©e manuellement (bouton) ou automatiquement (timer).

### üóÇÔ∏è Archive

L'ancien projet React a √©t√© archiv√© dans `archive-ancien-projet-react-*/` pour √©viter toute confusion.

## üß™ Tests CA Instant (Flux Direct)

### Test Complet du Flux (Console iPad)

1. **Rechargez l'app** (cache vide) :
    ```javascript
    localStorage.clear();
    caches&&caches.keys().then(k=>k.forEach(n=>caches.delete(n)));
    navigator.serviceWorker&&navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));
    location.replace(location.pathname+'?v='+Date.now());
    ```

2. **Testez d'abord le r√©seau simple** :
    ```javascript
    fetch('/api/caisse/facture', {method: 'GET', cache: 'no-store'})
    .then(r => { console.log('GET status:', r.status, r.ok); return r.json(); })
    .then(d => console.log('GET data:', d))
    .catch(e => console.log('GET erreur:', e))
    ```

3. **Injectez une facture de test (format avec prix TTC et remise)** :
    ```javascript
    fetch('/api/caisse/facture',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-Secret':'MySuperSecretKey2025'},
      body:JSON.stringify({
        numero_facture:'F-TEST-SYLVIE',
        date_facture:new Date().toISOString().slice(0,10),
        nom_client:'Client Test',
        montant_ttc:1440,
        payment_method:'card',
        vendeuse:'Sylvie',
        vendorId:'sylvie',
        produits:[{
          nom:'Matelas 140x190',
          quantite:1,
          prix_ttc:1440,
          remise:0.2
        }]
      })
    }).then(r=>r.json()).then(console.log).catch(console.error)
    ```

4. **Attendez 5‚Äì10 s**, puis ouvrez :
    - **"CA instant"** : Devrait afficher 1 440 ‚Ç¨ sous Sylvie
    - **"Ventes"** : Devrait lister la vente F-TEST-SYLVIE

5. **Si rien n'appara√Æt**, v√©rifiez les logs console (onglet "CA instant" g√©n√®re des logs "üìä CA INSTANTAN√â").

**Version actuelle** : v3.0.0-deduction-stock-automatique
